name: Workflow Monitor

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggering

permissions:
  issues: read
  discussions: read

jobs:
  monitor-workflow:
    runs-on: ubuntu-latest
    steps:
      - name: Check Discussion vs Issue Activity
        uses: actions/github-script@v7
        with:
          script: |
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const since = oneWeekAgo.toISOString();
            
            // Get discussions created in the last week
            const discussions = await github.graphql(`
              query($owner: String!, $repo: String!, $since: DateTime!) {
                repository(owner: $owner, name: $repo) {
                  discussions(first: 100, orderBy: {field: CREATED_AT, direction: DESC}) {
                    nodes {
                      title
                      createdAt
                      category {
                        name
                        slug
                      }
                      comments(first: 1) {
                        totalCount
                      }
                    }
                  }
                }
              }
            `, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              since: since
            });
            
            // Get issues created in the last week
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              since: since,
              state: 'all'
            });
            
            // Filter discussions created in the last week
            const recentDiscussions = discussions.repository.discussions.nodes.filter(
              d => new Date(d.createdAt) >= oneWeekAgo
            );
            
            // Generate report
            const report = `
## üìä Discussion-First Workflow Report

**Period:** ${oneWeekAgo.toDateString()} - ${new Date().toDateString()}

### üìà Activity Summary:
- **Discussions Created:** ${recentDiscussions.length}
- **Issues Created:** ${issues.data.length}
- **Conversion Ratio:** ${issues.data.length}/${recentDiscussions.length} (${((issues.data.length / Math.max(recentDiscussions.length, 1)) * 100).toFixed(1)}%)

### üìã Discussion Breakdown:
${recentDiscussions.map(d => 
  `- **${d.category.name}:** ${d.title} (${d.comments.totalCount} comments)`
).join('\n') || 'No discussions this week'}

### üéØ Issue Creation:
${issues.data.map(i => 
  `- **${i.title}** (Created: ${new Date(i.created_at).toDateString()})`
).join('\n') || 'No direct issues created ‚úÖ'}

### üîç Health Indicators:
- **Discussion Activity:** ${recentDiscussions.length > 0 ? '‚úÖ Active' : '‚ö†Ô∏è Low activity'}
- **Direct Issue Creation:** ${issues.data.length === 0 ? '‚úÖ Properly blocked' : '‚ö†Ô∏è ' + issues.data.length + ' direct issues created'}
- **Community Engagement:** ${recentDiscussions.filter(d => d.comments.totalCount > 0).length}/${recentDiscussions.length} discussions have responses

${issues.data.length > 0 ? `
### ‚ö†Ô∏è Action Required:
Direct issues were created this week. Check if:
- Issue templates are properly disabled
- Discussions redirects are working
- Users are bypassing the workflow
` : ''}

---
*This report is generated automatically to help monitor the discussion-first workflow effectiveness.*
            `;
            
            console.log(report);
            
            // You could also create an issue or discussion with this report
            // For now, just log it to Actions output
